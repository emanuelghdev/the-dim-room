<!DOCTYPE html>

<html>
    <head>
        <meta charset="utf-8">
        <title>The Dim Room</title>
        <link rel="stylesheet" href="css/styles.css">
        <link rel="icon" href="imgs/favicon.png" type="image/x-icon">
        <script type="text/javascript" src="libs/jquery.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sweetalert@2/dist/sweetalert.min.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
        
        <script type="importmap">
            {
                "imports": {
                    "three": "./libs/three.module.js"
                }
            }
        </script>

        <script type="module" src="objects/MyScene.js"></script> 

        <div style="position: absolute; left:100px; top:10px; color:white;" id="Messages"> 
        </div>
    </head>
    <body style="cursor: crosshair;">
        <!-- Pantalla de inicio -->
        <div id="loader-screen">
            <div id="loader-logo">
                <h1 id="title">
                    <span id="T">T</span>
                    <span id="H">h</span>
                    <span id="E">e</span>
                    <span class="sp">&nbsp;</span>
                    <span id="D">D</span>
                    <span id="I">i</span>
                    <span id="M">m</span>
                    <span class="sp">&nbsp;</span>
                    <span id="R">R</span>
                    <span id="O1">o</span>
                    <span id="O2">o</span>
                    <span id="M2">m</span>
                </h1>
            </div>
            <div id="loader-bar-container">
                <div id="loader-bar"></div>
            </div>
            <div id="loader-text"><p>Loading: 0%</p></div>
        </div>

        <!-- Div para mostrar mensajes personalizados -->
        <div id="message-card" class="message-card hidden">
            <div class="message-card-content">
                <div id="message-card-text"></div>
                <span id="message-card-close">➯</span>
            </div>
        </div>

        <!-- Div para mostrar la información estadísticas -->
        <div id="Stats-output" style="display: none;">
        </div>

        <!-- Div para contener el Output de WebGL -->
        <div id="WebGL-output">
        </div>

        <!-- Pantalla final -->
        <div id="end-screen" class="end-screen hidden">
            <div class="end-screen-content">
                <h1>The Dim Room</h1>
                <div class="end-screen-text">
                    <p>Has podido salir de la habitacion... <span class="red-text">¡Felicidades, te has pasado el juego!</span></p>
                    <p>Esto que acabas de jugar es un <span class="yellow-text">proyecto personal</span> creado con WebGL y Three.js</p>
                    <p>Si te interesa como está hecho es de código abierto y está disponible <a href="https://github.com/emanuelghdev/the-dim-room">aquí</a></p>
                    <p><a href="https://github.com/emanuelghdev/the-dim-room/blob/main/NOTICE">Créditos</a></p>
                </div>
                <button id="end-restart">Volver a jugar</button>
            </div>
        </div>
    </body>

    <script type="module">
        import * as THREE from 'three';
        import { MyScene } from './objects/MyScene.js';
        
        // Variables globales
        window.isPaused = false;        // Para pausar/reanudar el loop
        window.canStart = false;        // Para permitir entrar al juego tras carga

        // Referencias DOM
        const loaderScreen = document.getElementById('loader-screen');
        const loaderBar = document.getElementById('loader-bar');
        const loaderText = document.getElementById('loader-text');
        const card = document.getElementById('message-card');
        const textElem = document.getElementById('message-card-text');
        const endScreen    = document.getElementById('end-screen');
        const btnRestart   = document.getElementById('end-restart');

        // Función para mostrar mensajes en la partida
        function showCard(text) {
            // Seteamos el texto y muestra la card
            textElem.innerHTML = text;
            card.classList.remove('hidden');

            // Pausamos el loop de actualización
            window.isPaused = true;

            // Listener global para cerrar al primer click
            function closeOnClick() {
                // Evitamos que siga hacia Three.js
                event.stopPropagation();
                event.preventDefault();

                // Ocultamos y reanudamos
                card.classList.add('hidden');
                window.isPaused = false;

                // Drenamos el delta acumulado durante la pausa
                window.scene.clock.getDelta();

                // Reseteamos cualquier movimiento de ratón "en el aire"
                const ctrl = window.scene.cameraControl;
                ctrl.pointerX = 0;
                ctrl.pointerY = 0;

                // Volvemos a arrancar el bucle de animación
                window.scene.update();

                // Quitamos este listener
                document.removeEventListener('mousedown', closeOnClick);
            }
            document.addEventListener('mousedown', closeOnClick);
        }

        window.showCard = showCard;

        // Configuración de LoadingManager de Three.js
        THREE.DefaultLoadingManager.onProgress = (url, itemsLoaded, itemsTotal) => {
            const prog = Math.round(itemsLoaded / itemsTotal * 100);
            loaderBar.style.width = prog + '%';
            loaderText .innerHTML = `<p>Loading: ${prog}%</p>`;
        };
        THREE.DefaultLoadingManager.onLoad = () => {
            loaderBar.style.width = '100%';
            loaderText.innerHTML = '<p>Carga completada</p> <p>(Haz click para comenzar)</p>';
            window.canStart = true;
        };

        // Función de carga e inicio
        function startGame() {
            loaderScreen.style.display = 'none';
            document.getElementById('Stats-output').style.display  = 'block';
            window.isPaused = false;
            scene.update();
            
            // Eliminamos el listener
            loaderScreen.removeEventListener('mousedown', onStartClick);
        }

        function onStartClick(e) {
            if (!window.canStart) return;
            if (loaderScreen.style.display === 'none') return;
            if (e.button !== 0) return;  // Solo botón izquierdo
            e.preventDefault();
            startGame();
        }

        loaderScreen.addEventListener('mousedown', onStartClick);

        // Evitamos el raycast mientras loader activo
        loaderScreen.addEventListener('mousedown', e => {
            e.stopPropagation();
            e.preventDefault();
        });

        // Función para mostrar la pantalla final
        function showEndScreen() {
            window.isPaused = true;

            // Ocultamos stats/canvas
            document.getElementById('Stats-output').style.display  = 'none';
            document.getElementById('WebGL-output').style.filter   = 'blur(4px)';
            endScreen.classList.remove('hidden');
        }

        // Handler para reiniciar
        btnRestart.addEventListener('click', () => {
            location.reload();
        });

        window.showEndScreen = showEndScreen;
    </script>
</html>
